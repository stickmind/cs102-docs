<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="泛型编程" href="../../topic_4.html" /><link rel="prev" title="实验 3：栈和堆" href="../lab_3/index.html" />

    
    <link rel="shortcut icon" href="_static/favicon.ico"/>
        <title>作业 3：有趣的堆 - CS102 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/pied-piper-admonition.css?v=e32e2275" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     天将降大任于斯人也，必先苦其心志 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">CS102 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">CS102 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_0.html">开发环境</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 开发环境</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_0/linux_intro/index.html">Linux 介绍</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Linux 介绍</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/linux_intro/linux_on_windows.html">Windows MSYS2 环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/linux_intro/linux_virtual_box.html">Ubuntu 虚拟机</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_0/command_line/linux_command.html">Linux 命令行</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Linux 命令行</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/command_line/basic.html">基本命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/command_line/file_operation.html">文件操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/command_line/searching.html">文件搜索</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_0/from_cxx_to_c/from_cxx_to_c.html">从 C++ 到 C</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 从 C++ 到 C</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/from_cxx_to_c/simpio.html">simpio.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/from_cxx_to_c/strlib.html">strlib.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/from_cxx_to_c/pig_latin.html">Pig Latin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_0/lab_0/index.html">实验 0：上手 Linux 开发环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_0/assign_0/index.html">作业 0：使用 Linux 和 C</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_1.html">数据的表示</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 数据的表示</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topic_1/bit_byte/index.html">位、字节和进制</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_1/int_representation/index.html">整数的表示</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 整数的表示</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_1/int_representation/index2.html">整型溢出和转换</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_1/bit_level_ops/index.html">位运算及其应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_1/lab_1/index.html">实验 1. 数据的表示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_1/assign_1/index.html">作业 1. 有趣的位</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_2.html">数组和指针</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of 数组和指针</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_2/string/index.html">字符串</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of 字符串</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_2/string/string.html">字符串表示</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_2/string/string-h.html">string.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_2/string/char-star.html">字符串指针</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_2/array_and_pointer/index.html">数组和指针</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 数组和指针</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_2/array_and_pointer/star-pointer.html">理解 <code class="docutils literal notranslate"><span class="pre">*p</span></code> 的特殊性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_2/array_and_pointer/array_and_pointer_ops.html">数组索引和指针运算</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_2/array_and_pointer/array_and_pointer_mis.html">多维数组和二级指针</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_2/function_paremeters/index.html">函数参数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_2/lab_2/index.html">实验 2. 数组和指针</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_2/assign_2/index.html">作业 2. C 字符串</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../topic_3.html">栈和堆</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 栈和堆</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../memory_layout/index.html">内存布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memeory_management/index.html">内存管理</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../struct/index.html">结构体</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of 结构体</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../struct/stack_adt.html">设计栈抽象数据类型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../lab_3/index.html">实验 3：栈和堆</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">作业 3：有趣的堆</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_4.html">泛型编程</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of 泛型编程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/void_pointer/index.html">泛型指针</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/function_pointer/index.html">函数指针</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/lab_4/index.html">实验 4：泛型和回调</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/assign_4/index.html">作业 4：深入泛型指针</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_5.html">汇编语言</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of 汇编语言</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_5/asm_intro/index.html">汇编概述</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of 汇编概述</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_5/asm_intro/index2.html">程序员视角下的硬件</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_5/x86-64_asm/index.html">x86-64 指令</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of x86-64 指令</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_5/x86-64_asm/data_move.html">数据传送指令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_5/x86-64_asm/arithmetic_and_logic.html">算术与逻辑指令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_5/x86-64_asm/control.html">控制指令</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_5/asm_tools/index.html">汇编工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_5/lab_5/index.html">实验 5：汇编和运行时栈</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_5/assign_5/index.html">作业 5：来一点汇编</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>返回顶部</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>作业 3：有趣的堆<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>本次作业既用于测试你对话题 3 的理解，也是对话题 2 的进一步探索。在动态内存的基础上，继续深入研究数组和指针，并通过以下几个方面的训练，培养你的技能：</p>
<ul class="simple">
<li><p>操作指针和数组</p></li>
<li><p>管理栈和堆上的内存分配</p></li>
<li><p>使用 C 标准库中的 I/O 函数</p></li>
<li><p>使用 Valgrind 等工具辅助追踪内存错误和泄漏</p></li>
</ul>
<p>为了帮助你评估学习进度，对于每个作业/实验，我们罗列了一些要点，并提供了一些思考问题。在完成作业后，可以使用这些问题进行自我检查。如果你不能很好地回答这些问题，那么还需要进一步努力。</p>
<ul class="simple">
<li><p>作业 2 中编写的 <code class="docutils literal notranslate"><span class="pre">scan_token</span></code> 函数要求用户提供内存，用于存储扫描的词元。而作业 3 中的 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 函数却为用户分配好了内存。这两种方法有何优缺点？</p></li>
<li><p>据说，一个正确的程序，<code class="docutils literal notranslate"><span class="pre">malloc</span></code> 调用和 <code class="docutils literal notranslate"><span class="pre">free</span></code> 调用应该是一一对应的。如果添加了 <code class="docutils literal notranslate"><span class="pre">realloc</span></code> 调用，这将如何改变所需的 <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 和 <code class="docutils literal notranslate"><span class="pre">free</span></code> 调用数量？</p></li>
<li><p>内存错误和内存泄漏哪个问题更严重，为什么？如何区分 Valgrind 报告了哪种错误？</p></li>
<li><p>对于运行时或内存分配的效率，如何衡量你的程序是否具有可接受的性能？</p></li>
<li><p>什么时候适合使用 <code class="docutils literal notranslate"><span class="pre">calloc</span></code> 代替 <code class="docutils literal notranslate"><span class="pre">malloc</span></code>？</p></li>
</ul>
<section id="id2">
<h2>初始项目<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>你的个人用户目录下应该已经有 <code class="docutils literal notranslate"><span class="pre">cs102</span></code> 这个文件夹了，通过下面的命令拷贝初始代码到该目录中：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>-r<span class="w"> </span>/home/cs102-shared/assignments/assign3<span class="w"> </span>~/cs102
</pre></div>
</div>
</section>
<section id="id3">
<h2>内存分配<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>本次作业提供了许多内存管理的针对性训练。编程过程中，你将出于各种目的使用栈和堆，并且需要注意适当地分配和正确地释放。以下是关于内存的一些通用指南以及针对程序的一些建议：</p>
<ul class="simple">
<li><p>栈分配（stack allocation）就像声明变量一样简单。栈很方便（自动分配/释放）、具备类型安全并且非常高效。</p></li>
<li><p>动态分配是通过 <code class="docutils literal notranslate"><span class="pre">malloc/realloc/free</span></code> 进行的。利用堆内存，程序员能够控制生命周期（显式分配/释放）并提高程序的灵活性（可以调整存储大小/重新调整用途），但会牺牲安全性和效率。</p></li>
<li><p>注意理解栈分配与堆分配的正确使用以及两者适用的场景。根据一般的经验，除非必须使用动态分配的情况，首选栈分配。这两种技术通常会在程序中同时出现。在以下情况下，堆分配是必要的：</p>
<ul>
<li><p>需要一个非常大的内存分配，可能会耗尽栈空间</p></li>
<li><p>需要控制内存的生命周期，或者内存必须在函数调用之外持续存在</p></li>
<li><p>需要在初始分配后调整内存大小</p></li>
</ul>
</li>
</ul>
<p>始终使用 Valgrind 至关重要。查看 <a class="reference external" href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1206/resources/valgrind.html">Valgrind 指南</a>并回顾实验 2 和 3 中的练习，确保熟练使用 Valgrind。特别是：</p>
<ul class="simple">
<li><p>内存错误。这是迄今为止让 Valgrind 辅助我们编程的最重要原因。如果 Valgrind 报告错误，则需要立即处理。</p></li>
<li><p>内存泄漏。如果 Valgrind 报告泄漏，则说明有一些堆内存分配后没有释放。内存泄漏通常不会立刻导致程序错误，但错误的释放反而可能会导致错误，因此我们建议在程序完成之前不要担心内存释放的问题。开发完成后，再单独处理内存释放，并确保每一步的正确性。</p></li>
</ul>
</section>
<section id="id4">
<h2>背景：过滤命令<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">uniq</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tail</span></code> 是一类特殊的命令，称为“过滤器”。过滤器是这样一种程序，它从用户或文件中读取输入（通常是逐行读入），以某种方式转换输入，并生成一些输出。其他一些过滤器命令还有 <code class="docutils literal notranslate"><span class="pre">cat</span></code>、<code class="docutils literal notranslate"><span class="pre">sort</span></code> 和 <code class="docutils literal notranslate"><span class="pre">grep</span></code> 等。</p>
<p><code class="docutils literal notranslate"><span class="pre">cat</span></code> 是所有过滤器中最简单的，直接将输入进行输出。调用 <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">filename</span></code> 将打印指定文件的内容。 文档 <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">cat</span></code> 表明，如果没有给出文件名参数，该命令将从<strong>标准输入</strong>读取。这意味着程序将读取用户在终端上键入的行。几乎每个过滤器（例如 <code class="docutils literal notranslate"><span class="pre">grep</span></code> <code class="docutils literal notranslate"><span class="pre">wc</span></code> <code class="docutils literal notranslate"><span class="pre">less</span></code> <code class="docutils literal notranslate"><span class="pre">head</span></code> <code class="docutils literal notranslate"><span class="pre">sort</span></code> 等）都遵循相同的接口，要么从指定的文件读取，要么从标准输入读取。从标准输入读取可以方便地进行快速测试，无需提前创建文件。</p>
<p>自己尝试一下：</p>
<ul class="simple">
<li><p>调用 <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">Makefile</span></code> 来查看文件的内容。</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">-b</span></code> 参数可以对非空白行进行编号：<code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">-b</span> <span class="pre">Makefile</span></code>。</p></li>
<li><p>现在调用不带文件名参数的 <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">-b</span></code>，此时程序将等待你键入输入。</p></li>
<li><p>输入一行文本并按 Enter 键，观察该行及其行号的对应关系。再输入几行，也会进行输出并编号。</p></li>
<li><p>完成输入后，在单独的一行上按 <code class="docutils literal notranslate"><span class="pre">Control-d</span></code>，这表示输入结束（<code class="docutils literal notranslate"><span class="pre">EOF</span></code> 表示“文件结束”），过滤程序将退出。</p></li>
</ul>
<p>下面是一些其他可供探索的过滤器。对于每个命令，请浏览 <code class="docutils literal notranslate"><span class="pre">man</span></code> 文档以了解其选项。在现有文件上运行过滤器，然后在没有文件名的情况下再次运行过滤器并通过标准输入进行操作。请记住，<code class="docutils literal notranslate"><span class="pre">Control-d</span></code> 用于发出 <code class="docutils literal notranslate"><span class="pre">EOF</span></code> 信号。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">head</span></code> 打印输入的前几行</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tail</span></code> 打印输入的后几行</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wc</span></code> 打印输入中的行数、单词数和字符数</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span></code> 从输入中打印与搜索模式匹配的行</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uniq</span></code> 从输入中过滤掉相邻的重复行</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sort</span></code> 按顺序重新排列输入并打印</p></li>
</ul>
<p>在标准输入上运行时，你会注意到某些过滤器会立即响应输入的每一行，例如如果与模式匹配，<code class="docutils literal notranslate"><span class="pre">grep</span></code> 会立刻回显该行。其他的命令，例如 <code class="docutils literal notranslate"><span class="pre">sort</span></code>，在你发出 <code class="docutils literal notranslate"><span class="pre">EOF</span></code> 信号之前不会输出任何内容。这取决于过滤器操作是否需要查看所有输入才能确定输出内容。</p>
<p>过滤器的真正威力在于它们可以组合成“管道”。管道是一系列命令，其中一个命令的输出被传递到（或“通过管道传输到”）下一个命令的输入。管道字符 <code class="docutils literal notranslate"><span class="pre">|</span></code> 将一个命令的输出作为下一个命令的输入。过滤器在管道中特别有用，因为它们可以在开始、中间或末尾使用。</p>
<p>管道允许你通过组合基本的过滤器，构建出更强大的操作。以下是一些例子：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">include</span> <span class="pre">util.c</span> <span class="pre">|</span> <span class="pre">wc</span> <span class="pre">-l</span></code> 在 <code class="docutils literal notranslate"><span class="pre">util.c</span></code> 中查找包含“include”的行，并将它们提供给 <code class="docutils literal notranslate"><span class="pre">wc</span></code>，<code class="docutils literal notranslate"><span class="pre">wc</span></code> 输出其接收到的输入中的行数。因此，该管道将输出匹配的行数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">-b</span> <span class="pre">util.c</span> <span class="pre">|</span> <span class="pre">tail</span></code> 输出 <code class="docutils literal notranslate"><span class="pre">util.c</span></code> 中标有行号的行，并将它们提供给 <code class="docutils literal notranslate"><span class="pre">tail</span></code>，后者仅输出最后 10 行和行号。</p></li>
<li><p>标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 命令仅过滤掉输入中相邻的重复行，而你的版本将过滤掉输入中任何位置出现的重复行。因此，使用标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 命令时，如果你的数据中有分散的重复行，则需要先重新排序，以便让重复项保持相邻位置，然后 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 才会检测到它们。我们可以使用三阶管道来输出文件中不同行的计数：<code class="docutils literal notranslate"><span class="pre">sort</span> <span class="pre">samples/names</span> <span class="pre">|</span> <span class="pre">uniq</span> <span class="pre">|</span> <span class="pre">wc</span> <span class="pre">-l</span></code>。首先，<code class="docutils literal notranslate"><span class="pre">sort</span></code> 将 <code class="docutils literal notranslate"><span class="pre">samples/names</span></code> 排序并输出给 <code class="docutils literal notranslate"><span class="pre">uniq</span></code>，<code class="docutils literal notranslate"><span class="pre">uniq</span></code> 忽略相邻的重复项输出到 <code class="docutils literal notranslate"><span class="pre">wc</span></code>，最后 <code class="docutils literal notranslate"><span class="pre">wc</span></code> 统计接收到的输入的行数并打印。</p></li>
<li><p>现在轮到你了！如何编写一个管道来打印 <code class="docutils literal notranslate"><span class="pre">samples/names</span></code> 中三个最常见的名称？</p></li>
</ul>
<p>Unix/Linux 的哲学是放弃构建单一的万能程序，而是鼓励创建更小的命令。每个命令都只负责某个单一任务，并足够精简。这些小的、离散的工具，通过管道进行组合，从而完成更大的任务。在本次作业中，你将编写其中的两个工具：<code class="docutils literal notranslate"><span class="pre">uniq</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tail</span></code>。</p>
</section>
<section id="id5">
<h2>任务 1：阅读和注释<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>程序 <code class="docutils literal notranslate"><span class="pre">mycat</span></code>、<code class="docutils literal notranslate"><span class="pre">mytail</span></code> 和 <code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 依赖于文件读取操作。文件读取的工作原理大都类似，但在不同语言中具有不同的语法。你的第一个任务是研究作业初始代码以及 <a class="reference external" href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1206/guide/stdlib.html">C 标准库指南</a>，大致了解 C 语言文件读取的工作原理。我们为你提供了完整的测试程序 <code class="docutils literal notranslate"><span class="pre">mycat.c</span></code>。而 <code class="docutils literal notranslate"><span class="pre">myuniq.c</span></code> 和 <code class="docutils literal notranslate"><span class="pre">mytail.c</span></code> 的起始文件包含处理命令行参数和文件设置的代码，其余部分将由你来实现。你应该先阅读并理解给定的代码，弄清楚如何更改并扩展它以满足你的需求，最后记得添加注释来记录你的实现策略。</p>
<p>查看初始代码时，有一些需要考虑的问题：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fopen</span></code> 的 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 参数有哪些可能的选项？如果你尝试打开一个不存在的或没有权限的文件，会发生什么情况？</p></li>
<li><p>未能正确关闭文件的后果是什么？</p></li>
<li><p>当没有文件名参数时，程序如何切换到标准输入进行读取？</p></li>
<li><p>从文件读取的操作是否也可以用于从标准输入读取，还是说这两种操作需要不同的代码？</p></li>
<li><p>程序 <code class="docutils literal notranslate"><span class="pre">mycat</span></code> 的默认行为对应于调用标准 <code class="docutils literal notranslate"><span class="pre">cat</span></code> 时，使用哪个命令行标志？</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mytail</span></code> 支持命令行参数 <code class="docutils literal notranslate"><span class="pre">-number</span></code> 来控制打印的行数。初始代码如何处理该可选参数？</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mytail</span> <span class="pre">-number</span></code> 的参数范围是什么？</p></li>
</ul>
<p>与往常一样，我们提供的代码已删除了注释，你的工作就是为 <code class="docutils literal notranslate"><span class="pre">mytail.c</span></code>、<code class="docutils literal notranslate"><span class="pre">myuniq.c</span></code> 和 <code class="docutils literal notranslate"><span class="pre">util.c</span></code> 文件编写缺失的文档。可以不用注释 <code class="docutils literal notranslate"><span class="pre">mycat.c</span></code> 文件。</p>
</section>
<section id="read-line">
<h2>任务 1：实现 read_line<a class="headerlink" href="#read-line" title="Link to this heading">#</a></h2>
<p>标准库函数 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 用于从文件中读取文本。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">fgets</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bufsize</span><span class="p">,</span><span class="w"> </span><span class="kt">FILE</span><span class="o">*</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
</pre></div>
</div>
<p>与大多数库函数一样，<code class="docutils literal notranslate"><span class="pre">fgets</span></code> 不进行任何分配，而是由用户提供缓冲区用于写入。用户必须根据预期的大小预先分配“足够大的”内存来存储该行。如果用户提供的内存太小，则函数可能会发生缓冲区溢出（如果使用 <code class="docutils literal notranslate"><span class="pre">gets</span></code>）或截断读取操作（如果使用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code>）。</p>
<p>一个对用户更友好的设计是由读取函数在内部处理内存分配并创建适当大小的行。你将实现一个以这种方式运行的 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 函数：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">read_line</span><span class="p">(</span><span class="kt">FILE</span><span class="o">*</span><span class="w"> </span><span class="n">fp</span><span class="p">);</span>
</pre></div>
</div>
<p>函数 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 从文件中读取下一行。返回值是一个动态分配的且以空字符结尾的字符串（如果读到 <code class="docutils literal notranslate"><span class="pre">EOF</span></code>，即“文件结尾”，则返回 <code class="docutils literal notranslate"><span class="pre">NULL</span></code>）。此函数的执行方式是类似于 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 的更时尚的版本（事实上，你应该使用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 来实现它！），因为它不仅可以读取下一行，还可以为字符串分配内存，这将使用户的工作变得更轻松。</p>
<p>以下是该函数操作的一些具体细节：</p>
<ul class="simple">
<li><p>该函数应该从文件中读取下一行。所谓“一行”，就是遇到第一个换行符或 <code class="docutils literal notranslate"><span class="pre">EOF</span></code>（以先到者为准），然后结束读取。</p></li>
<li><p>返回的字符串应该包含换行符前的所有字符，但不应包括换行符本身。如果下一行仅包含换行符，则返回空字符串。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 到达 <code class="docutils literal notranslate"><span class="pre">EOF</span></code>，意味着没有更多字符可以读取，则该函数应返回 <code class="docutils literal notranslate"><span class="pre">NULL</span></code>。请注意，需要先调用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code>，然后才能检查 <code class="docutils literal notranslate"><span class="pre">EOF</span></code> 条件，因为尝试读取超出文件末尾的过程会触发 <code class="docutils literal notranslate"><span class="pre">EOF</span></code> 条件。这种情况应该清理所有预先分配的不再需要的内存，并返回 <code class="docutils literal notranslate"><span class="pre">NULL</span></code>。</p></li>
<li><p>如果调用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 时发生错误，该函数应该返回该时刻已读取的所有内容，如果没有读取任何内容，则返回 <code class="docutils literal notranslate"><span class="pre">NULL</span></code>（提示：即便你没有考虑到这种情况，你的函数最终可能仍然能够按此逻辑执行）。在这种情况下，你可以假设如果在调用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 期间发生错误，则该时刻不会读取任何字符。</p></li>
<li><p>要为返回的字符串分配内存，该函数应该先进行初始分配，并在需要时对其扩容。更具体地说，函数应该首先 <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 一个最小的缓冲区（32 字节），第一次调用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 时，先将行的前一部分读入缓冲区。如果还有更多内容需要读取，函数应该重新分配缓冲区，并将当前大小翻倍（64 字节），并再次调用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 读取该行的剩余部分。重复这样的过程，翻倍扩容并写入内容，直到最终到达该行的换行符或 <code class="docutils literal notranslate"><span class="pre">EOF</span></code>，此时表明一行读取完毕。</p></li>
<li><p>如果无法分配足够的内存，<code class="docutils literal notranslate"><span class="pre">read_line</span></code> 应该触发致命断言。养成一种好习惯，你应该为每次分配请求的结果添加断言 <code class="docutils literal notranslate"><span class="pre">assert</span></code>。分配失败的情况虽然很少见，但却是致命的。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read_line</span></code> 应该返回动态分配的内存块的地址，该位置存储下一行的内容。不再需要时，用户负责释放该内存。</p></li>
<li><p>你应该只需要使用 <code class="docutils literal notranslate"><span class="pre">fgets</span></code> 文件 I/O 函数，不需要使用任何其他函数，例如 <code class="docutils literal notranslate"><span class="pre">feof</span></code>、<code class="docutils literal notranslate"><span class="pre">fgetc</span></code> 等。</p></li>
</ul>
<p>在 <code class="docutils literal notranslate"><span class="pre">util.c</span></code> 文件中编写 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 的实现。你可以使用我们提供的 <code class="docutils literal notranslate"><span class="pre">mycat.c</span></code> 程序对其进行测试。 <code class="docutils literal notranslate"><span class="pre">mycat</span></code> 程序与 <code class="docutils literal notranslate"><span class="pre">sanitycheck</span></code> 集成。稍后你将使用 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 函数继续编写 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 和 <code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 程序。</p>
<p>注意：你可以假设正在读取的不是二进制可执行文件。可执行文件可能包含“空字节”，或全零字节。在处理字符串时，这些可能被当作空字符 <code class="docutils literal notranslate"><span class="pre">NUL</span></code> 来处理，从而让实现更棘手，所以你不必担心这一点。</p>
</section>
<section id="mytail">
<h2>任务 2：实现 mytail<a class="headerlink" href="#mytail" title="Link to this heading">#</a></h2>
<blockquote>
<div><p><strong>注意</strong> 如何对管道中运行的程序使用 <code class="docutils literal notranslate"><span class="pre">gdb/valgrind</span></code>？</p>
<p>GDB 和 Valgrind 不能很好地与管道配合使用。一种简单的替代方法是，为待测试的输入编写一个文件，然后在该文件上运行 <code class="docutils literal notranslate"><span class="pre">gdb/valgrind</span></code> 程序。提供输入时，你可以使用重定向 <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> 来捕获命令的输出。</p>
</div></blockquote>
<p>标准 <code class="docutils literal notranslate"><span class="pre">tail</span></code> 命令是一个过滤器命令，读取输入，并按顺序打印输入的最后 <code class="docutils literal notranslate"><span class="pre">N</span></code> 行。 <code class="docutils literal notranslate"><span class="pre">N</span></code> 的值默认为 <code class="docutils literal notranslate"><span class="pre">10</span></code>，但也可以设置为命令行标志，例如 <code class="docutils literal notranslate"><span class="pre">tail</span> <span class="pre">-4</span></code>。以下是 <code class="docutils literal notranslate"><span class="pre">tail</span></code> 的使用示例：</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>samples/colors
red
green
green
yellow
blue
blue
blue
blue
$<span class="w"> </span>tail<span class="w"> </span>-3<span class="w"> </span>samples/colors<span class="w"> </span>
blue
blue
blue
</pre></div>
</div>
<p>如果输入包含的总行数少于 <code class="docutils literal notranslate"><span class="pre">N</span></code>，则打印输入中的所有行。</p>
<p>你要编写的 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 程序在操作上与标准 <code class="docutils literal notranslate"><span class="pre">tail</span></code> 类似，但存在以下差异：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mytail</span></code> 仅支持一个命令行标志 <code class="docutils literal notranslate"><span class="pre">-N</span></code>，其中 <code class="docutils literal notranslate"><span class="pre">N</span></code> 是要输出的行数（标准 <code class="docutils literal notranslate"><span class="pre">tail</span></code> 有许多其他标志）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mytail</span></code> 只读取一个文件：指定文件（如果指定）或标准输入（如果没有）（标准 <code class="docutils literal notranslate"><span class="pre">tail</span></code> 可以从任意数量的文件参数读取）</p></li>
</ul>
<p>当 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 处理其输入时，它需要跟踪 <code class="docutils literal notranslate"><span class="pre">N</span></code> 个行。为此，你必须使用包含 <code class="docutils literal notranslate"><span class="pre">N</span></code> 个条目的数组。在任何时候，该数组都保存最近读取的 <code class="docutils literal notranslate"><span class="pre">N</span></code> 行。该数组是一个由 <code class="docutils literal notranslate"><span class="pre">N</span></code> 行组成的“滑动窗口”（slide window），它在输入过程中移动。当 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 到达输入末尾时，该窗口仅包含最后 <code class="docutils literal notranslate"><span class="pre">N</span></code> 行。</p>
<p>当 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 开始处理输入时，它将使用 <code class="docutils literal notranslate"><span class="pre">read_line</span></code> 函数将前 <code class="docutils literal notranslate"><span class="pre">N</span></code> 行读入数组。读取第 <code class="docutils literal notranslate"><span class="pre">N+1</span></code> 行时，不应扩大数组，而应丢弃输入的第一行（最初的行）并将该数组位置用于存储第 <code class="docutils literal notranslate"><span class="pre">N+1</span></code> 行。 <code class="docutils literal notranslate"><span class="pre">N+2</span></code> 行覆盖最初的第二行，依此类推。这样，数组就相当于一种循环队列，在任何时候最多存储最近读取的 <code class="docutils literal notranslate"><span class="pre">N</span></code> 行。</p>
<p>由于数组大小是预先已知的并且在其生命周期内不会改变，因此该数组是使用栈分配的好机会。实现该程序的挑战是理解循环队列的逻辑以及要小心分配和释放字符串。</p>
<p>重要提示：确保理解 Slide Window 方法，并按该方法实现你的 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 程序！有些地方也将该数组称作“环形缓冲区”。</p>
</section>
<section id="myuniq">
<h2>任务 3：实现 myuniq<a class="headerlink" href="#myuniq" title="Link to this heading">#</a></h2>
<p>标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 是一个过滤器，处理提供的输入，删除相邻的重复行，然后输出。当使用 <code class="docutils literal notranslate"><span class="pre">-c</span></code> 标志调用 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 时，它会计算每行出现的次数。以下是 <code class="docutils literal notranslate"><span class="pre">uniq</span> <span class="pre">-c</span></code> 的使用示例：</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>samples/colors
red
green
green
yellow
blue
blue
blue
blue
$<span class="w"> </span>uniq<span class="w"> </span>-c<span class="w"> </span>samples/colors<span class="w"> </span>
<span class="w">    </span><span class="m">1</span><span class="w"> </span>red
<span class="w">    </span><span class="m">2</span><span class="w"> </span>green
<span class="w">    </span><span class="m">1</span><span class="w"> </span>yellow
<span class="w">    </span><span class="m">4</span><span class="w"> </span>blue
</pre></div>
</div>
<p>你要编写的 <code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 程序在操作上与标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 类似，但有一些差异：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 过滤掉所有重复行，无论它们出现在输入中的何处（标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 仅检测输入中彼此相邻的重复行）</p></li>
<li><p>每个重复行仅打印一次，打印顺序与输入中出现的顺序相同。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 总是在输出的每一行前面加上前缀，表示该行在输入中出现次数的（这是使用 <code class="docutils literal notranslate"><span class="pre">-c</span></code> 标志调用标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 的行为）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 不支持任何命令行标志（标准 <code class="docutils literal notranslate"><span class="pre">uniq</span></code> 有许多标志）</p></li>
</ul>
<p>为了检测输入中任意位置的重复行，<code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 必须跟踪输入过程中看到的所有行。它还需要计算每行重复的次数。定义一个结构体数组，可以存储这些信息，帮助我们完成这项工作，但我们仍有一个难题。这个数组需要多少个条目？与 <code class="docutils literal notranslate"><span class="pre">mytail</span></code> 提前确定数组的分配大小不同，<code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 的数组大小是不确定的。它可能需要一个包含 <code class="docutils literal notranslate"><span class="pre">10</span></code> 个条目的数组，或 <code class="docutils literal notranslate"><span class="pre">10,0000</span></code> 个条目的数组。如果尝试选择一个固定值，对于某些输入来说可能太大，而对于另一些输入来说则太小。听起来，似乎按需分配才是最合理的！</p>
<p>我们对 <code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 要求是，先为数组分配 <code class="docutils literal notranslate"><span class="pre">100</span></code> 个条目作为初始大小，如果该数组填满时，调整数组大小用于添加另外 <code class="docutils literal notranslate"><span class="pre">100</span></code> 个条目。然后根据需要重复此操作，每次添加额外的 <code class="docutils literal notranslate"><span class="pre">100</span></code> 个条目。（注意这里的策略不是翻倍）</p>
<p>为了匹配示例程序的输出格式，在打印行的计数时，你应该使用 <code class="docutils literal notranslate"><span class="pre">printf</span></code> 标记 <code class="docutils literal notranslate"><span class="pre">%7d</span></code> 而不仅仅是 <code class="docutils literal notranslate"><span class="pre">%d</span></code>。这将打印宽度为 <code class="docutils literal notranslate"><span class="pre">7</span></code> 的数字，输出将类似于：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="mi">1</span> <span class="n">red</span>
   <span class="mi">5000</span> <span class="n">blue</span>
  <span class="mi">12413</span> <span class="n">green</span>
<span class="mi">1253473</span> <span class="n">yellow</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">myuniq</span></code> 程序中的大部分挑战都与能否正确处理内存有关。当完成本次作业时，你将成为堆内存管理大师！</p>
</section>
<section id="id6">
<h2>测试与提交<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>本次作业也会查看你的程序的内存和运行时效率。对于内存效率，Valgrind 可以提供巨大的帮助，因为 Valgrind 报告包含有关总堆使用情况的统计信息。在 Valgrind 报告末尾查找以下格式的行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="n">heap</span> <span class="n">usage</span><span class="p">:</span> <span class="mi">10</span> <span class="n">allocs</span><span class="p">,</span> <span class="mi">10</span> <span class="n">frees</span><span class="p">,</span> <span class="mi">888</span> <span class="nb">bytes</span> <span class="n">allocated</span>
</pre></div>
</div>
<p>这是程序生命周期内所有堆分配的总和。分配计数应始终等于释放计数。分配计数和分配的总大小是程序内存“占用空间”的衡量标准。</p>
<p>运行时效率（程序运行的速度）也很重要。在命令前面加上执行时间并报告完成该命令所用的时间。例如，<code class="docutils literal notranslate"> <span class="pre">time</span> <span class="pre">./mytail</span></code> 将测量程序的运行时间，而 <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">samples/mytail_soln</span></code> 将测量示例程序的运行时间。标记为“用户”的时间是我们感兴趣的部分。</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./mytail<span class="w"> </span>-1<span class="w"> </span>samples/dictionary
zygote

real<span class="w">    </span>0m0.010s
user<span class="w">    </span>0m0.006s
sys<span class="w">     </span>0m0.000s
</pre></div>
</div>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>samples/mytail_soln<span class="w"> </span>-1<span class="w"> </span>samples/dictionary
zygote

real<span class="w">    </span>0m0.009s
user<span class="w">    </span>0m0.007s
sys<span class="w">     </span>0m0.000s
</pre></div>
</div>
<p>那么如何确保分配适当的内存，以及合理的运行时效率呢？最佳策略是使用给定输入测量示例程序，并用相同输入测量你的程序。如果你的程序和示例程序的结果大致相同（例如在 2 或 3 倍之内），那么你的实现就没什么大问题。当考虑空间与时间的权衡时，示例程序向你展示了我们正在寻找的平衡点。如果你的程序使用明显更多的内存或时间，则表明你的程序有一些不必要或多余的工作应该消除。请务必注意，非常小的输入对于有意义的测量来说太小；相反，你应该测量较大的输入，以查看程序的大规模运行情况。</p>
<p>作为作业的一部分，你应该尽可能完善 <code class="docutils literal notranslate"><span class="pre">custom_tests</span></code> 中的测试案例，至少添加 3 到 5 个。为了更好的可读性，也建议你为代码和测试用例编写注释或文档。这些注释用于说明每个测试的初衷，以及这些测试之间的相互关系。</p>
<p>遵循实验 3 中介绍的调试策略，一个关键原则是<strong>不要随意更改代码</strong>：</p>
<ul class="simple">
<li><p><strong>观察漏洞行为</strong>。</p></li>
<li><p><strong>创建一个可复现输入</strong>。</p></li>
<li><p><strong>缩小检查范围</strong>。</p></li>
<li><p><strong>分析</strong>。</p></li>
<li><p><strong>设计实验并验证</strong>。</p></li>
<li><p><strong>修改代码消除错误</strong>。</p></li>
</ul>
<p>作业提交方式参考作业 0，可以使用 <code class="docutils literal notranslate"><span class="pre">submit</span></code> 提交你的代码。为了追求完美，一些加分项值得你去注意：</p>
<ul class="simple">
<li><p>编译是否干净，有无警告等编译错误？</p></li>
<li><p>默认测试是否全部通过？</p></li>
<li><p>自定义测试案例是否全面？</p></li>
</ul>
<p>对于代码实现部分：</p>
<ul class="simple">
<li><p>有没有其他地方，还可以使用位运算进行改写？</p></li>
<li><p>算法是否高效？还记得如何分析算法复杂度吗？</p></li>
<li><p>代码风格及可读性是否注意过？有没有进行函数拆分，提取出一些更通用的代码？</p></li>
<li><p>有没有尝试编写文档？一份好的代码就如同一篇优美的散文，不多一字，也不少一字。加油！</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../topic_4.html">
              <div class="page-info">
                <div class="context">
                  <span>下一页</span>
                </div>
                <div class="title">泛型编程</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../lab_3/index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>上一页</span>
                </div>
                
                <div class="title">实验 3：栈和堆</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, <a href='https://www.stickmind.com/' target="_blank">StickMind</a>
            </div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            本页目录
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">作业 3：有趣的堆</a><ul>
<li><a class="reference internal" href="#id2">初始项目</a></li>
<li><a class="reference internal" href="#id3">内存分配</a></li>
<li><a class="reference internal" href="#id4">背景：过滤命令</a></li>
<li><a class="reference internal" href="#id5">任务 1：阅读和注释</a></li>
<li><a class="reference internal" href="#read-line">任务 1：实现 read_line</a></li>
<li><a class="reference internal" href="#mytail">任务 2：实现 mytail</a></li>
<li><a class="reference internal" href="#myuniq">任务 3：实现 myuniq</a></li>
<li><a class="reference internal" href="#id6">测试与提交</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=7d86a446"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    </body>
</html>