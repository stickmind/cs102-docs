<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="数组和指针" href="../../topic_2.html" /><link rel="prev" title="实验 1. 数据的表示" href="../lab_1/index.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>作业 1. 有趣的位 - CS102 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/pied-piper-admonition.css?v=e32e2275" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     Please use <a href='https://pradyunsg.me/furo/'>the main documentation</a> instead. 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">CS102 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">CS102 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_0.html">开发环境</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 开发环境</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_0/linux_intro/index.html">Linux 介绍</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Linux 介绍</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/linux_intro/linux_on_windows.html">Windows MSYS2 环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/linux_intro/linux_virtual_box.html">Ubuntu 虚拟机</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_0/command_line/linux_command.html">Linux 命令行</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Linux 命令行</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/command_line/basic.html">基本命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/command_line/file_operation.html">文件操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/command_line/searching.html">文件搜索</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../topic_0/from_cxx_to_c/from_cxx_to_c.html">从 C++ 到 C</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 从 C++ 到 C</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/from_cxx_to_c/simpio.html">simpio.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/from_cxx_to_c/strlib.html">strlib.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../topic_0/from_cxx_to_c/pig_latin.html">Pig Latin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_0/lab_0/index.html">实验 0：上手 Linux 开发环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_0/assign_0/index.html">作业 0：使用 Linux 和 C</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../topic_1.html">数据的表示</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 数据的表示</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bit_byte/index.html">位、字节、进制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../int_representation/index.html">整数的表示</a></li>
<li class="toctree-l2"><a class="reference internal" href="../int_representation/index2.html">整型溢出和转换</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bit_level_ops/index.html">位运算及其应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_1/index.html">实验 1. 数据的表示</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">作业 1. 有趣的位</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../topic_2.html">数组和指针</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../topic_3.html">栈和堆</a></li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topic_4.html">泛型编程</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 泛型编程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/void_pointer/index.html">泛型指针</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/function_pointer/index.html">函数指针</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/lab_4/index.html">实验 4：泛型和回调</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topic_4/assign_4/index.html">作业 4：深入泛型指针</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>作业 1. 有趣的位<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>本次作业要求你完成三个程序，每个程序探索位运算或数字操作的某个特定方面。需要你编写的代码很短，但这些代码片段却非常强大！</p>
<p>这次作业用于测试你对第一个话题的理解。通过以下几个方面的训练，培养你的技能：</p>
<ul class="simple">
<li><p>利用远程 Linux 开发环境，编辑、编译、测试并调试 C 程序​</p></li>
<li><p>使用 C 位运算符和算术运算符编写操作位和整数的代码​</p></li>
<li><p>在整数表示的限制下编写代码</p></li>
</ul>
<p>为了帮助你评估学习进度，对于每个作业/实验，我们罗列了一些要点，并提供了一些思考问题。在完成作业后，可以使用这些问题进行自我检查。如果你不能很好地回答这些问题，那么还需要进一步努力。</p>
<ul class="simple">
<li><p>绝对值是 2 的幂的所有负整数（-8、-32 等）的位模式有什么共同点？</p></li>
<li><p>如何确定整数位模式是否具有一对连续的“on”位？（使用循环将很简单，但也有一个巧妙的单一表达式……）</p></li>
<li><p>斯坦福大学计算机科学博士 Sean Anderson 有一个位魔法宝库 <a class="reference external" href="http://graphics.stanford.edu/~seander/bithacks.html">Bit Twiddling Hacks</a>，推荐收藏。</p></li>
</ul>
<section id="id2">
<h2>初始项目<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>你的个人用户目录下应该已经有 <code class="docutils literal notranslate"><span class="pre">cs102</span></code> 这个文件夹了，通过下面的命令拷贝初始代码到该目录中：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cs102</span><span class="o">-</span><span class="n">shared</span><span class="o">/</span><span class="n">assignments</span><span class="o">/</span><span class="n">assign1</span> <span class="o">~/</span><span class="n">cs102</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>阅读并注释<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>作业初始代码作为一个起点，你的首要任务应该是仔细阅读它。你要先弄清楚代码是如何运行的，以及它已经处理了哪些任务。基于这些代码框架，你可以规划如何开发自己的程序。每个程序大约有 25 行，需要你添加的代码可能只有十几行，因此需要你阅读的初始代码比你添加的新代码要多得多。</p>
<p>为了帮助你更好地上手作业任务开发，我们为每个程序提供了一些现成的代码，有些用于处理命令行参数，有些用于处理程序调用时的用户错误，还有一些比较重要的细节，特别是将字符串参数转换为数字。</p>
<p>作业 0 中的 <code class="docutils literal notranslate"><span class="pre">triangle</span></code> 程序使用了 <code class="docutils literal notranslate"><span class="pre">atoi</span></code> 函数，该函数使用起来相对简单一些，但却无法检测格式错误的输入。对于本次作业的这些程序，我们使用更强大但却更复杂的 <code class="docutils literal notranslate"><span class="pre">strtol</span></code> 函数。阅读 <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">strtol</span></code> 中的函数文档并查看该函数在 <code class="docutils literal notranslate"><span class="pre">convert_arg</span></code> 中的使用方式。</p>
<p>下面一些问题可以用于自测：</p>
<ul class="simple">
<li><p>在缺少参数的情况下调用 <code class="docutils literal notranslate"><span class="pre">samples</span></code> 中的示例程序，程序将如何响应？如果参数过多又将如何？</p></li>
<li><p>​如何使用 <code class="docutils literal notranslate"><span class="pre">error</span></code> 函数？</p></li>
<li><p>将用户的字符串参数转换为数字时，传递给 <code class="docutils literal notranslate"><span class="pre">strtol</span></code> 的基数是什么？这允许用户指定哪些基数的参数？另外，如何根据用户参数确定基数？</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">strtol</span></code> 在要转换的字符串中遇到无效字符，它会做什么？</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">strtol</span></code> 的第二个参数如何用于错误检测？为什么 <code class="docutils literal notranslate"><span class="pre">end</span></code> 变量不用初始化也可以使用呢？如果不希望进行错误检测，你会传递什么作为第二个参数？</p></li>
<li><p>如果要求转换的值太大而无法用 <code class="docutils literal notranslate"><span class="pre">long</span></code> 表示，<code class="docutils literal notranslate"><span class="pre">strtol</span></code> 会做什么？</p></li>
</ul>
<p>阅读完代码后，尝试进行一些实验！构建并运行程序，使用不同的参数调用它们，看看每个程序是如何处理的。也可以在调试器下运行程序，逐步执行每行代码，并随时打印中间值。通过观察代码的运行情况，可以更好地理解代码。如果你能很好地回答上述自测问题，那么对初始代码的理解就够了，开始接下来的任务吧。</p>
</section>
<section id="id4">
<h2>其他建议<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>为了帮助你完成这次作业，我们整理了一些技巧，可以帮助你解决很多问题以及一些常见的位运算。</p>
<p><strong>拥抱十六进制</strong>。十六进制可以非常方便地与二进制进行转换。每个字节都用两个十六进制数字表示，一个表示 4 个高位，另一个表示 4 个低位。十六进制掩码或通过其构造的掩码，可以更好地映射到二进制表示形式，并减少编码错误。例如，从 32 位值中提取符号位的掩码可以清晰地表示为 <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">&lt;&lt;</span> <span class="pre">31</span></code> 或 <code class="docutils literal notranslate"><span class="pre">0x80000000</span></code>，并且两者的可读性都非常好。该掩码也恰好是十进制的 <code class="docutils literal notranslate"><span class="pre">2147483648U</span></code>，但谁能一眼看出来呢？如果不小心输错了，比如 <code class="docutils literal notranslate"><span class="pre">2147486348U</span></code>，你能注意到吗？所以，不要使用十进制，优选十六进制！</p>
<p><strong>学习位运算</strong>。调用 <code class="docutils literal notranslate"><span class="pre">pow</span></code> 函数来计算 2 的整数幂是一种浪费。使用 <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">&lt;&lt;</span> <span class="pre">10</span></code> 可以完美地计算 <code class="docutils literal notranslate"><span class="pre">pow(2,</span> <span class="pre">10)</span></code>，并且需要更少的计算周期。位运算也是重排/隔离/更改位的正确工具，而不是间接地使用包含 2 的幂的整数乘法/除法/取模。</p>
<p><strong>力求直接明了</strong>。可能有更直接的方法来编写某些位运算。以下是一些示例：</p>
<p><em>不要左移右移</em>。在下面的代码中，第一个版本先右移然后立即左移，这个操作似乎只是将位模式循环回到原来的位置，但实际上右移将丢弃 <code class="docutils literal notranslate"><span class="pre">lsb</span></code>，然后左移将填零。这是擦除 <code class="docutils literal notranslate"><span class="pre">lsb</span></code> 的迂回方法，而更好的方法是直接将其屏蔽，如第二个版本所示：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">     </span><span class="c1">// original version</span>

<span class="c1">// Better version:</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">1</span><span class="p">;</span><span class="w">            </span><span class="c1">// better: directly turn off lsb</span>
</pre></div>
</div>
<p><em>不要有多余/不必要的操作</em>。想象一下，你的目标是提取一个字节的 4 个高位，并将它们下移到低半字节。你可以通过两个步骤（掩码和移位）来完成此操作，但实际上，移位已经丢弃低位了，因此无需掩码操作！</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">   </span><span class="c1">// mask off lower 4, then shift down</span>

<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">            </span><span class="c1">// better: directly shift, </span>
<span class="w">                              </span><span class="c1">// low-order bits gone!</span>
</pre></div>
</div>
<p><em>不要掉进复杂的陷阱</em>。当构造组合的位运算时，先考虑是否有更直接的方法来完成同样的事情，例如：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">                     </span><span class="c1">// this is no op!</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mi">-1</span><span class="w">                    </span><span class="c1">// more clearly written as b = ~a</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">                    </span><span class="c1">// more clearly written as b = -a</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">            </span><span class="c1">// INT_MAX from &lt;limits.h&gt; </span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MIN</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="w">             </span><span class="c1">// This is -1!</span>
</pre></div>
</div>
<p>起初，你可能会发现需要使用更长的表达式，但是仔细思考，你会发现还有更简洁的写法。最终的目标是避免将问题复杂化。</p>
</section>
<section id="id5">
<h2>任务 1：饱和计算<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>程序 <code class="docutils literal notranslate"><span class="pre">sat</span></code> 执行合成的饱和加法运算，饱和加法将结果限制在可表示的范围内。与补码加法“超范围即溢出”的行为不同，饱和加法在出现正溢出时返回该类型的最大值，在出现负溢出时返回最小值。饱和计算函数在图形学和数字信号处理应用中非常常见。</p>
<p>以下是 <code class="docutils literal notranslate"><span class="pre">sat</span></code> 程序的两个示例。第一个示例打印出 8 位有符号整数的取值范围是 <span class="math notranslate nohighlight">\([-128, 127]\)</span>。第二个示例尝试将 126 加到 5，结果会溢出并保持在最大值 127。</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./sat<span class="w"> </span><span class="m">8</span>
<span class="m">8</span>-bit<span class="w"> </span>signed<span class="w"> </span>integer<span class="w"> </span>range
min:<span class="w"> </span>-128<span class="w">   </span>0xffffffffffffff80
max:<span class="w">  </span><span class="m">127</span><span class="w">   </span>0x000000000000007f
$<span class="w"> </span>./sat<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">126</span><span class="w"> </span><span class="m">5</span>
<span class="m">126</span><span class="w"> </span>+<span class="w"> </span><span class="nv">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">127</span>
</pre></div>
</div>
<p>你的任务是编写以下函数，来实现 <code class="docutils literal notranslate"><span class="pre">sat</span></code> 程序的饱和加法。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="nf">signed_min</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bitwidth</span><span class="p">);</span>
<span class="kt">long</span><span class="w"> </span><span class="nf">signed_max</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bitwidth</span><span class="p">);</span>
<span class="kt">long</span><span class="w"> </span><span class="nf">sat_add</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">operand1</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">operand2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bitwidth</span><span class="p">);</span>
</pre></div>
</div>
<p>参数 <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> 是 4 到 64 之间的数字。以位宽 <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> 表示的二进制补码有符号整数将被限制在固定范围内。函数 <code class="docutils literal notranslate"><span class="pre">signed_min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">signed_max</span></code> 返回该范围的最小值和最大值。函数 <code class="docutils literal notranslate"><span class="pre">sat_add</span></code> 实现饱和加法运算，如果结果在范围内，则返回其操作数的总和；如果结果溢出，则根据情况返回最小/最大值。虽然此处两个操作数的类型为 <code class="docutils literal notranslate"><span class="pre">long</span></code>，但你可以假设操作数的值始终位于位宽 <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> 表示的有符号整数的范围内。话虽如此，但这么处理也意味着以位宽 <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> 表示的值的位数，实际上可能多于所需的位数。所以，这些额外的位需要进行合适的处理，以确保该值在 <code class="docutils literal notranslate"><span class="pre">long</span></code> 范围内能够进行正确的计算。</p>
<p>在编写 <code class="docutils literal notranslate"><span class="pre">sat.c</span></code> 的代码时，有三个重要的限制需要注意：</p>
<ul class="simple">
<li><p><strong>不可以使用关系运算符或 <code class="docutils literal notranslate"><span class="pre">math.h</span></code> 中的函数</strong>。禁止使用关系运算符意味着，你的代码不可以出现 <code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">&gt;</span> <span class="pre">&lt;=</span> <span class="pre">&gt;=</span></code> 这些比较操作，但你可以使用 <code class="docutils literal notranslate"><span class="pre">!=</span> <span class="pre">==</span></code> 进行相等性检查。你也不应该调用 <code class="docutils literal notranslate"><span class="pre">math.h</span></code> 库中的任何函数，例如 <code class="docutils literal notranslate"><span class="pre">pow</span></code>、<code class="docutils literal notranslate"><span class="pre">exp2</span></code> 等。这些限制旨在引导你使用纯粹的位运算来实现代码。对于其他运算符，例如算术运算符、逻辑运算符、按位运算符……这里不作限制。</p></li>
<li><p><strong>参数 <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> 没有特殊情况</strong>。无论位宽 <code class="docutils literal notranslate"><span class="pre">bitwidth</span></code> 的值是 4、64 还是介于两者之间的任何值，你的函数都必须使用一个统一的代码来处理。不可以对某些位宽的值进行特殊处理，比如使用 <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">switch</span> <span class="pre">?:</span></code> 根据位宽的值将代码分为不同的情况。但是，这并不意味着不能使用条件逻辑，例如单独处理溢出或非溢出的情况。</p></li>
<li><p><strong>不要使用循环或递归</strong>。此程序根本不需要循环或递归。</p></li>
</ul>
<p>违反以上任何一个限制的代码都是不合格的，因此，请仔细检查你的实现是否合规！</p>
</section>
<section id="id6">
<h2>任务 2：细胞自动机<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>细胞自动机用于模拟细胞群落的生命周期，你可以将其视为一维细胞阵列，每个细胞可以是活的（live）也可以是死的（empty）。从初始模式开始，自动机使用一组简单的规则模拟后代细胞的出生和死亡。在这部分作业中，你将使用位和位运算实现细胞自动机，以便尽可能有效地利用内存。</p>
<p>这里将细胞群表示为一个 64 位无符号长整型数，每个位用于表示一维世界中的一个细胞。 <code class="docutils literal notranslate"><span class="pre">1</span></code> 表示单元格处于 live 状态，<code class="docutils literal notranslate"><span class="pre">0</span></code> 表示单元格处于 empty 状态。一个位的邻居是其紧邻的左右两侧单元格。规则集（ruleset）根据当前细胞及其邻居的状态，计算出该细胞在下一代中是活的还是死的。基于这种位向量的表示，读取和更新单个位可以使用位运算来完成。</p>
<p>Daniel Shiffman 的精美著作《代码的本质》对模拟的工作原理进行了精彩的解释。感兴趣可以阅读 <a class="reference external" href="https://natureofcode.com/book/chapter-7-cellular-automata/">Chapter 7. Cellular Automata</a> 以获取更多背景信息。请注意，这里将使用比这些例子更复杂的细胞群落，但想法是一样的。阅读这些背景信息后，请继续阅读以下文字，以确认你对模拟过程的理解。（注意，上述链接的第 7.3 节也实现了一个自动机程序，但它采用了更重量级的数组/OO 设计。这里采用更简化的位运算来实现。）</p>
<p>如何从当前一代生成下一代？正如上述章节中提到的，一个单元格及其两个邻居形成了一个“邻域”。一个邻域实际上是 3 个位组成的数字，值的范围从 0 到 7。考虑一个活的单元，其左邻居是活的而右邻居是死的，二进制邻域表示为 <code class="docutils literal notranslate"><span class="pre">110</span></code>，即 3 个位表示的数字 <code class="docutils literal notranslate"><span class="pre">6</span></code>。那么该单元的下一代是活的还是死的，由规则集位置 <code class="docutils literal notranslate"><span class="pre">6</span></code> 的配置决定。规则集是一个 8 位的数字，每个位表示一个邻域的配置。假设规则集是 <code class="docutils literal notranslate"><span class="pre">77</span></code>，用二进制表示为 <code class="docutils literal notranslate"><span class="pre">01001101</span></code>。以最低有效位表示位置 0，则位置 6 的配置是 <code class="docutils literal notranslate"><span class="pre">1</span></code>，也就是说，这个单元的下一代是活的。</p>
<p>程序 <code class="docutils literal notranslate"><span class="pre">automata</span></code> 演示了一个基本的细胞自动机，根据指定的规则集，从初始状态开始进行多次迭代。如果下一代的状态不再改变，迭代就会提前终止。在下述输出中，每行代表一代，从顶部的第一代到底部的最后一代。下面显示了规则集 <code class="docutils literal notranslate"><span class="pre">77</span></code> 的程序运行示例：</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./automata<span class="w"> </span><span class="m">77</span>
<span class="w">                               </span>+<span class="w">                                </span>
++++++++++++++++++++++++++++++<span class="w"> </span>+<span class="w"> </span>+++++++++++++++++++++++++++++++
+<span class="w">                            </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">                             </span>+
+<span class="w"> </span>++++++++++++++++++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++++++++++++++++++++++++++<span class="w"> </span>+
+<span class="w"> </span>+<span class="w">                        </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">                         </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>++++++++++++++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++++++++++++++++++++++<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w">                    </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">                     </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>++++++++++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++++++++++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">                </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">                 </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>++++++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++++++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">            </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">             </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++++++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">        </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">         </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++++++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">    </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w">     </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>++<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+<span class="w"> </span>+
</pre></div>
</div>
<p>很酷吧？由于规则集是一个 8 位数字，这意味着细胞的演化将有 256 个不同的可能。可以尝试探索一些不同的值，看看有哪些非常酷的输出结果！</p>
<p>你的任务是为程序 <code class="docutils literal notranslate"><span class="pre">automata</span></code> 实现这些函数：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">draw_generation</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">gen</span><span class="p">);</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">advance</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">gen</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">ruleset</span><span class="p">);</span>
</pre></div>
</div>
<p>函数 <code class="docutils literal notranslate"><span class="pre">draw_generation</span></code> 输出一个 64 字符组成的行，一个字符表示一个单元格。活细胞显示为 <code class="docutils literal notranslate"><span class="pre">+</span></code>（或者改为预定义的常量，参见作业代码），死细胞显示为空白。每一代的状态都是排好序的，与最高有效位（MSB）对应的单元位于最左列，而最低有效位（LSB）位于最右列中。<strong>建议优先实现这个函数</strong>。完成后，如果你运行该程序，它应该为第一代打印出一行，为下一代打印一个空行（这是由下面的 <code class="docutils literal notranslate"><span class="pre">advance</span></code> 函数初始代码返回的内容），接着它将停止迭代，因为后续状态没有改变。</p>
<p>函数 <code class="docutils literal notranslate"><span class="pre">advance</span></code> 会执行一次迭代，从当前一代生成下一代。对于每个细胞，该函数检查其邻域并根据规则集来确定下一代细胞的状态。<strong>外侧边缘的两个单元，由于只有一个邻居，需要特殊处理；不存在的邻居应该被视为死亡状态</strong>。</p>
<p>建议使用 <code class="docutils literal notranslate"><span class="pre">sanitycheck</span></code> 比较你的输出与示例程序的输出，而不是手动检查。为了便于识别，<code class="docutils literal notranslate"><span class="pre">sanitycheck</span></code> 会将活细胞显示为 <code class="docutils literal notranslate"><span class="pre">*</span></code>，将空细胞显示为 <code class="docutils literal notranslate"><span class="pre">.</span></code>。测试程序时，尝试使用不同的规则集。</p>
<p>你能找到产生谢尔宾斯基三角形的规则集吗？倒置的谢尔宾斯基三角形的规则集是什么？你最喜欢哪个规则集产生的输出？将这些规则集补充到 <code class="docutils literal notranslate"><span class="pre">custom_tests</span></code>，完善测试用例。</p>
</section>
<section id="utf-8">
<h2>任务 3：UTF-8<a class="headerlink" href="#utf-8" title="Link to this heading">#</a></h2>
<p>C 中的 <code class="docutils literal notranslate"><span class="pre">char</span></code> 是一种单字节数据类型，能够存储 <span class="math notranslate nohighlight">\(2^8\)</span> 种不同的位模式。 ASCII 编码标准 (<code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">ascii</span></code>) 为这些模式建立了到各种字母、数字和标点符号的映射，但仅限于 256 个选项，因此仅包含一个子集。 Unicode 是类似 ASCII 的更国际化的编码标准，它定义了一个通用字符集，支持现代和古代多种世界语言的字形（<a class="reference external" href="http://www.unicode.org/charts/PDF/U13000.pdf">中文，埃及象形文字，原始表情符号等</a>）。然而，如此大量的字符需要一个与单个字符不同的编码系统。对于这部分作业，你将实现最流行的 Unicode 编码 UTF-8，根据<a class="reference external" href="https://w3techs.com/technologies/cross/character_encoding/ranking">最近的统计</a>，超过 98% 的网站（具有已知的字符编码）都使用该编码！</p>
<p>Unicode 将每个字符映射到一个<strong>码点</strong>（code point），该码点是一个十六进制数字。Unicode 标准中有超过 100 万个不同的码点！字符的码点通常以 <code class="docutils literal notranslate"><span class="pre">U+NNNN</span></code> 格式编写，表示十六进制值 <code class="docutils literal notranslate"><span class="pre">0xNNNN</span></code>。</p>
<p>然而，Unicode 标准没有指定如何以二进制形式最高效地编码这些码点。如何实际存储给定的码点，有多种可能的 Unicode 编码方式。为什么要存在多种编码方式？可能是有不同的优先级，也可能为了与其他非 Unicode 编码兼容，还有其预期的语言环境，空间效率等。根据编码方式的不同，一些问题可能有不同的答案：较小的码点是否应该与较大的码点占用相同的空间量？如果不是，我们如何确定编码的长度？是否可以保持与其他编码（例如 ASCII）的兼容性？</p>
<p>最流行的 Unicode 编码之一是 UTF-8。 UTF-8 之所以流行，部分原因是它保留了与 ASCII 的向后兼容性——事实上，它的设计使 ASCII 成为了 UTF-8 的子集，这意味着 ASCII 编码中表示的字符在 ASCII 和 UTF-8 中具有相同的编码。</p>
<p>UTF-8 编码使用 1 到 4 个字节表示一个码点，具体取决于码点的大小。如果它处在 <code class="docutils literal notranslate"><span class="pre">U+0000</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+007F</span></code> 范围内，则其 UTF-8 编码长度为 1 个字节。如果它处在 <code class="docutils literal notranslate"><span class="pre">U+0080</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+07FF</span></code> 范围内，则其 UTF-8 编码长度为 2 个字节。如果它处在 <code class="docutils literal notranslate"><span class="pre">U+0800</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+FFFF</span></code> 范围内，则其 UTF-8 编码长度为 3 个字节。最后还有一个 4 字节范围，但在本次作业中我们将忽略它。</p>
<p>UTF-8 的工作方式是将码点的二进制表示形式拆分到用于编码的字节中。</p>
<ul>
<li><p>从 <code class="docutils literal notranslate"><span class="pre">U+0000</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+007F</span></code> 的码点最多使用 7 位（这些称为“有效位”），编码使用 1 个字节</p>
<p>其最高有效位为 0，其余位作为 7 个码点有效位。</p>
</li>
<li><p>从 <code class="docutils literal notranslate"><span class="pre">U+0080</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+07FF</span></code> 的码点最多有 11 个有效位，编码使用 2 个字节</p>
<p>第一个字节前缀是 <code class="docutils literal notranslate"><span class="pre">110</span></code>，后面跟着 5 个最高码点有效位；第二个字节前缀是 <code class="docutils literal notranslate"><span class="pre">10</span></code>，后面是其余 6 个码点有效位。</p>
</li>
<li><p>从 <code class="docutils literal notranslate"><span class="pre">U+0800</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+FFFF</span></code> 的码点最多有 16 个有效位，编码使用 3 个字节</p>
<p>第一个字节前缀是 <code class="docutils literal notranslate"><span class="pre">1110</span></code>，后面跟着 4 个最高码点有效位；第二个字节前缀是 <code class="docutils literal notranslate"><span class="pre">10</span></code>，后面跟着 6 个最高码点有效位；第三个字节前缀是 <code class="docutils literal notranslate"><span class="pre">10</span></code>，后面是最后 6 个码点有效位。</p>
</li>
</ul>
<p>下面的表格总结了上面的设计规范。对于每个字节的布局，所有表示形式的 0 和 1 位都是固定的。<code class="docutils literal notranslate"><span class="pre">xxx</span></code> 位存储码点的二进制表示形式。</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Code Point Range</p></th>
<th class="head"><p>Significant Bits</p></th>
<th class="head"><p>UTF-8 Encoded Bytes (Binary)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">U+0000</span></code> to <code class="docutils literal notranslate"><span class="pre">U+007F</span></code></p></td>
<td><p>7</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0xxxxxxx</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">U+0080</span></code> to <code class="docutils literal notranslate"><span class="pre">U+07FF</span></code></p></td>
<td><p>11</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">110xxxxx</span> <span class="pre">10xxxxxx</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">U+0800</span></code> to <code class="docutils literal notranslate"><span class="pre">U+FFFF</span></code></p></td>
<td><p>16</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1110xxxx</span> <span class="pre">10xxxxxx</span> <span class="pre">10xxxxxx</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p>如你所见，单字节序列存储码点的 7 位，双字节序列存储 11 位（第一个字节 5 位，另一个字节 6 位），三字节序列存储 16 位（分别存储 4 位、6 位和 6 位）。UTF-8 字节长度取决于存储码点的所有位需要多少字节（1 表示最多 7 个有效位，2 表示最多 11 个有效位，3 表示最多 16 个有效位）。</p>
<p>在单字节序列中，高位始终为 0，其他 7 位是码点本身的值。因此，前 128 个 Unicode 码点与 ASCII 字符使用相同的二进制表示！</p>
<p>对于多字节序列，第一个字节称为<strong>前导字节</strong>（leading byte），后续字节称为<strong>连续字节</strong>（continuation bytes）。前导字节的高位通过 1 的个数表示序列中的总字节数。例如，从 <code class="docutils literal notranslate"><span class="pre">U+0080</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+07FF</span></code> 的码点编码的前导字节以 <code class="docutils literal notranslate"><span class="pre">110</span></code> 开头，表示整个编码长度为 2 个字节，因为有两个 1。连续字节的高位始终为 <code class="docutils literal notranslate"><span class="pre">10</span></code>。然后将码点的二进制表示划分到前导字节和连续字节的低位。</p>
<p>以下编码过程摘自<a class="reference external" href="https://en.wikipedia.org/wiki/UTF-8">维基百科 UTF-8 英文页面</a>：</p>
<ul class="simple">
<li><p>考虑对欧元符号 <code class="docutils literal notranslate"><span class="pre">€</span></code> 进行编码，其 Unicode 码点是 <code class="docutils literal notranslate"><span class="pre">U+20AC</span></code>。</p></li>
<li><p>码点在 <code class="docutils literal notranslate"><span class="pre">U+0800</span></code> 到 <code class="docutils literal notranslate"><span class="pre">U+FFFF</span></code> 范围内，所以需要三个字节来存储。<code class="docutils literal notranslate"><span class="pre">0x20AC</span></code> 的二进制表示有 14 个有效位。</p></li>
<li><p>前导补充两个 0 后，<code class="docutils literal notranslate"><span class="pre">0x20AC</span></code> 的二进制形式是 <code class="docutils literal notranslate"><span class="pre">00100000</span> <span class="pre">10101100</span></code>。</p></li>
<li><p>我们来计算 UTF-8 编码的前导字节。高位是固定的 <code class="docutils literal notranslate"><span class="pre">1110</span></code>，表示三字节序列。低位存储码点的 4 个最高位。该字节最终形式为 <code class="docutils literal notranslate"><span class="pre">11100010</span></code>。码点还有 12 位需要编码。</p></li>
<li><p>接下来，我们来计算第一个连续字节。高位固定为 <code class="docutils literal notranslate"><span class="pre">10</span></code>，低位存储码点的接下来的 6 位。该字节是 <code class="docutils literal notranslate"><span class="pre">10000010</span></code>。码点还有 6 位需要编码。</p></li>
<li><p>最后，我们来计算最后一个连续字节。高位固定为 <code class="docutils literal notranslate"><span class="pre">10</span></code>，低位存储码点的最后 6 位。这个字节是 <code class="docutils literal notranslate"><span class="pre">10101100</span></code>。</p></li>
<li><p>由此最终的三字节序列是 <code class="docutils literal notranslate"><span class="pre">11100010</span> <span class="pre">10000010</span> <span class="pre">10101100</span></code>，可以更简洁地写为十六进制，如 <code class="docutils literal notranslate"><span class="pre">e2</span> <span class="pre">82</span> <span class="pre">ac</span></code>。</p></li>
</ul>
<p>你的任务是编写 <code class="docutils literal notranslate"><span class="pre">to_utf8</span></code> 函数，该函数接收一个 Unicode 码点并构造出 UTF-8 编码的字节序列。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">to_utf8</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">code_point</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">utf8_bytes</span><span class="p">[])</span>
</pre></div>
</div>
<p>函数 <code class="docutils literal notranslate"><span class="pre">to_utf8</span></code> 有两个参数；一个 <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">short</span></code> 类型的 <code class="docutils literal notranslate"><span class="pre">code_point</span></code> 和一个字节数组 <code class="docutils literal notranslate"><span class="pre">utf8_bytes</span></code>。该函数将构造给定码点的 UTF-8 表示形式，并将编码字节序列写入数组 <code class="docutils literal notranslate"><span class="pre">utf8_bytes</span></code> 中。第一个字节（例如前导字节）应位于数组的索引 0 处，其余字节（如果有的话，例如连续字节）应位于索引 1 处，依此类推。<code class="docutils literal notranslate"><span class="pre">utf8_bytes</span></code> 数组由客户端提供，要保证有足够的空间可以容纳完整的 3 个字节，尽管可能只需要 1 或 2 个字节。后续课程会更深入讨论 C 数组，如果你传递一个数组作为参数，修改该数组的元素将修改原始数组，类似 C++ 中的引用参数，因此上面的函数可以传回它创建的字节。该函数返回值是编码的字节数（1、2 或 3）。</p>
<p>你将在提供的 <code class="docutils literal notranslate"><span class="pre">utf8</span></code> 程序中实现这个函数，该程序采用一个或多个码点，并使用 <code class="docutils literal notranslate"><span class="pre">to_utf8</span></code> 函数显示每个码点的 UTF-8 十六进制编码和相应的字符字形。以下一个运行示例：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>utf8<span class="w"> </span>0x41<span class="w"> </span>0xfc<span class="w"> </span>0x3c0<span class="w"> </span>0x4751
U+0041<span class="w">   </span>UTF-8<span class="w"> </span>Hex:<span class="w"> </span><span class="m">41</span><span class="w">         </span>Character:<span class="w"> </span>A<span class="w">  </span>
U+00FC<span class="w">   </span>UTF-8<span class="w"> </span>Hex:<span class="w"> </span>c3<span class="w"> </span>bc<span class="w">      </span>Character:<span class="w"> </span>ü<span class="w">  </span>
U+03C0<span class="w">   </span>UTF-8<span class="w"> </span>Hex:<span class="w"> </span>cf<span class="w"> </span><span class="m">80</span><span class="w">      </span>Character:<span class="w"> </span>π<span class="w">  </span>
U+4751<span class="w">   </span>UTF-8<span class="w"> </span>Hex:<span class="w"> </span>e4<span class="w"> </span>9d<span class="w"> </span><span class="m">91</span><span class="w">   </span>Character:<span class="w"> </span>䝑
</pre></div>
</div>
<p>此任务通过提取/重排/打包位模式，是构造位掩码并应用位运算的一个极好实践。</p>
</section>
<section id="id7">
<h2>测试与提交<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<p>你的程序是否正确，很大程度上依赖于你的测试用例是否完善。如果测试不到位，一些隐藏的漏洞将很难被发现。经过 CS101 的训练，对于 TDD 的测试用例编写，我们可以总结一些基本的规范：</p>
<ul class="simple">
<li><p>黑盒测试：不需要了解程序的底层实现，以用户的视角来测试程序。一般要特别注意一些边界情况，比如作业 0 中的负值，比如一些参数类型不正确的情况。这些案例的编写需要你从客户视角，从多个角度思考真实场景下可能出现的问题。</p></li>
<li><p>白盒测试：需要你了解程序的底层实现。比如 CS101 中很多 ADT 都会包含一个 <code class="docutils literal notranslate"><span class="pre">debug</span></code> 接口，直接测试数据结构的底层表示。</p></li>
<li><p>压力测试：开发时用于测试的数据集一般较小，真实场景中很可能发生用户输入较多，造成程序崩溃的情况。</p></li>
</ul>
<p>在编写作业代码时，一个很好的测试策略是使用测试驱动开发，如下所示：</p>
<ul class="simple">
<li><p>确定一个小的具体任务（要修复的错误、要添加的功能、所需的行为更改）</p></li>
<li><p>为所需结果构建测试用例，并验证当前代码是否可以通过这些测试</p></li>
<li><p>修改代码，直到通过所有测试为止</p></li>
<li><p>测试系统的其余部分，以验证是否无意中破坏其他内容</p></li>
</ul>
<p>每次只需要更改少量代码，并通过精心构造的测试用例来验证结果。这样可以让你的开发过程稳步向前，同时确保你在每一步都有一个完整的功能实现。</p>
<p>作为作业的一部分，你应该尽可能完善 <code class="docutils literal notranslate"><span class="pre">custom_tests</span></code> 中的测试案例，至少添加 3 到 5 个。为了更好的可读性，也建议你为代码和测试用例编写注释或文档。这些注释将提醒你添加的每个测试的初衷，以及这些测试之间的相互关系。</p>
<p>例如，程序 <code class="docutils literal notranslate"><span class="pre">sat</span></code> 可以测试不同的位宽、极值、范围内的总和以及溢出的总和。对于 <code class="docutils literal notranslate"><span class="pre">automata</span></code>，请仔细查看在生成过程中，哪些地方有特殊情况，并编写明确的测试用例解决这些问题。虽然你可以向 <code class="docutils literal notranslate"><span class="pre">utf8</span></code> 提供大约 65,000 个可能的码点，但考虑到它们只有几个不同的情况，因此针对每个情况的典型测试用例将更有意义，特别是边界处的情况。</p>
<p>更多测试的建议，可以阅读 <a class="reference external" href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1206/testing">Software Testing Strategies
</a></p>
</section>
<section id="id8">
<h2>提交前的检查<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<p>作业提交方式参考作业 0，可以使用 <code class="docutils literal notranslate"><span class="pre">submit</span></code> 提交你的代码。为了追求完美，一些加分项值得你去注意：</p>
<ul class="simple">
<li><p>编译是否干净，有无警告等编译错误？</p></li>
<li><p>默认测试是否全部通过？</p></li>
<li><p>自定义测试案例是否全面？</p></li>
</ul>
<p>对于代码实现部分：</p>
<ul class="simple">
<li><p>有没有其他地方，还可以使用位运算进行改写？</p></li>
<li><p>算法是否高效？还记得如何分析算法复杂度吗？</p></li>
<li><p>代码风格及可读性是否注意过？有没有进行函数拆分，提取出一些更通用的代码？</p></li>
<li><p>文档有没有尝试编写？一份好的代码就如同一篇优美的散文，不多一字，也不少一字。加油！</p></li>
</ul>
<p>另外也鼓励你花点时间反思一下目前的状态，你已经掌握了哪些知识点和工具？还需要继续训练哪些新知识点和技能？完成这次作业后，你应该适应了 C 和命令行的使用，熟悉编写/编译/调试的过程。这是一个重要的里程碑！</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../topic_2.html">
              <div class="page-info">
                <div class="context">
                  <span>下一页</span>
                </div>
                <div class="title">数组和指针</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../lab_1/index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>上一页</span>
                </div>
                
                <div class="title">实验 1. 数据的表示</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, <a href='https://www.stickmind.com/' target="_blank">StickMind</a>
            </div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            本页目录
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">作业 1. 有趣的位</a><ul>
<li><a class="reference internal" href="#id2">初始项目</a></li>
<li><a class="reference internal" href="#id3">阅读并注释</a></li>
<li><a class="reference internal" href="#id4">其他建议</a></li>
<li><a class="reference internal" href="#id5">任务 1：饱和计算</a></li>
<li><a class="reference internal" href="#id6">任务 2：细胞自动机</a></li>
<li><a class="reference internal" href="#utf-8">任务 3：UTF-8</a></li>
<li><a class="reference internal" href="#id7">测试与提交</a></li>
<li><a class="reference internal" href="#id8">提交前的检查</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=7d86a446"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.staticfile.org/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    </body>
</html>